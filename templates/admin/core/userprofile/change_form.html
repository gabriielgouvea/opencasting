{% extends "admin/change_form.html" %}
{% load i18n admin_urls static admin_modify custom_filters %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    /**
     * OBJETO DE DADOS GLOBAL
     * Extraímos os dados do Django uma única vez. 
     * Isso resolve os erros 'expected' do VS Code e centraliza as informações.
     */
    const PROMOTOR_DATA = {
        uuid: "{{ original.uuid }}",
        nome: "{{ original.nome_completo|upper|escapejs }}",
        idade: "{{ original.data_nascimento|timesince|truncatewords:1 }} anos",
        nascimento: "{{ original.data_nascimento|date:'d/m/Y' }}",
        cpf: "{{ original.cpf|default:'---' }}",
        rg: "{{ original.rg|default:'---' }}",
        nacionalidade: "{{ original.get_nacionalidade_display|escapejs }}",
        genero: "{{ original.get_genero_display|escapejs }}",
        etnia: "{{ original.get_etnia_display|escapejs }}",
        whatsapp: "{{ original.whatsapp }}",
        instagram: "{{ original.instagram|default:'---'|escapejs }}",
        email: "{{ original.user.email|escapejs }}",
        endereco: "{{ original.endereco|escapejs }}",
        numero: "{{ original.numero }}",
        bairro: "{{ original.bairro|escapejs }}",
        cidade: "{{ original.cidade|escapejs }}",
        estado: "{{ original.estado }}",
        cep: "{{ original.cep }}",
        altura: "{{ original.altura }}",
        peso: "{{ original.peso }}",
        manequim: "{{ original.manequim }}",
        calcado: "{{ original.calcado }}",
        camiseta: "{{ original.get_tamanho_camiseta_display|escapejs }}",
        olhos: "{{ original.get_olhos_display|escapejs }}",
        cabelo: "{{ original.get_cabelo_tipo_display|escapejs }} ({{ original.get_cabelo_comprimento_display|escapejs }})",
        experiencia: "{{ original.get_experiencia_display|escapejs }}",
        disponibilidade: "{{ original.get_disponibilidade_display|escapejs }}",
        ingles: "{{ original.get_nivel_ingles_display|escapejs }}",
        espanhol: "{{ original.get_nivel_espanhol_display|escapejs }}",
        pix: "{{ original.chave_pix|default:'---'|escapejs }}",
        banco: "{{ original.banco|default:'---'|escapejs }}"
    };

    // 1. ALTERNAR VISUALIZAÇÃO
    function toggleEditForm() {
        const container = document.getElementById('edit-form-container');
        container.style.display = (container.style.display === 'none') ? 'block' : 'none';
        if (container.style.display === 'block') container.scrollIntoView({ behavior: 'smooth' });
    }

    // 2. CÓPIA DE AVALIAÇÃO
    function copiarLinkAvaliacao(uuid) {
        const url = window.location.origin + '/avaliar/' + uuid + '/';
        navigator.clipboard.writeText(url).then(() => {
            Swal.fire({ icon: 'success', title: 'Copiado!', text: 'Link de avaliação na área de transferência.', timer: 1500, showConfirmButton: false });
        });
    }

    // 3. GESTÃO DE SENHA
    function copiarLinkSenha(id) {
        fetch(`/admin/core/userprofile/${id}/gerar-link-senha/`)
            .then(response => response.json())
            .then(data => {
                navigator.clipboard.writeText(data.link).then(() => {
                    Swal.fire({ icon: 'success', title: 'Link Gerado!', text: 'Link de recuperação copiado.', timer: 2000, showConfirmButton: false });
                });
            });
    }

    // Chamadas para as funções globais do admin_custom.js
    function handleCopiaZap() { window.copiarInformacoesPerfil(PROMOTOR_DATA); }
    function handleCopiaLink() { window.configurarLinkPublico(PROMOTOR_DATA); }
</script>

<style>
    /* ============================================================
       ESTILOS CRM (VISUALIZAÇÃO E BACKEND)
       ============================================================ */
    .content-wrapper { background-color: #f4f6f9 !important; }
    
    .back-nav-link { 
        display: inline-flex; align-items: center; color: #666; text-decoration: none; 
        font-weight: 700; margin-bottom: 20px; transition: 0.2s; font-size: 0.8rem;
    }
    .back-nav-link:hover { color: #009688; transform: translateX(-5px); }

    .crm-header-card { 
        background: white; border-radius: 16px; padding: 30px; margin-bottom: 30px; 
        border: 1px solid #eee; box-shadow: 0 4px 20px rgba(0,0,0,0.04);
    }

    /* FIX DEFINITIVO: Dropdown que não some ao descer o mouse */
    .btn-group-custom { 
        position: relative; display: inline-block; 
        padding-bottom: 20px; /* Área de contato extra */
        margin-bottom: -20px; 
    }
    /* Ponte invisível entre o botão e o menu */
    .btn-group-custom::before {
        content: ""; position: absolute; top: 100%; left: 0; width: 100%; height: 25px; z-index: 1;
    }
    .dropdown-content {
        display: none; position: absolute; background-color: white; min-width: 250px;
        box-shadow: 0 10px 35px rgba(0,0,0,0.15); z-index: 9999; border-radius: 12px; 
        border: 1px solid #eee; top: 50px; left: 0; overflow: hidden; animation: fadeIn 0.3s;
    }
    .btn-group-custom:hover .dropdown-content { display: block !important; }

    .dropdown-content a, .dropdown-content button {
        width: 100%; text-align: left; padding: 14px 20px; border: none; background: none;
        font-size: 0.85rem; font-weight: 700; color: #333; display: flex; align-items: center; cursor: pointer;
    }
    .dropdown-content a:hover, .dropdown-content button:hover { background-color: #f8f9fa; color: #009688; }

    .btn-crm { 
        padding: 12px 25px; border-radius: 50px; font-weight: 800; font-size: 0.75rem;
        cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px;
        transition: 0.2s; text-decoration: none !important; color: white !important;
    }

    /* Grid de Resumo */
    .info-summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
    .info-summary-box { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 20px; position: relative; }
    .info-summary-box h4 { font-size: 0.75rem; font-weight: 900; color: #009688; border-bottom: 2px solid #f9f9f9; padding-bottom: 10px; margin-bottom: 15px; }
    .edit-pencil { position: absolute; right: 20px; top: 20px; color: #ccc; cursor: pointer; transition: 0.2s; }
    .edit-pencil:hover { color: #009688; transform: scale(1.2); }

    /* FORMULÁRIO DE EDIÇÃO (LIBERAÇÃO DE SELECTS) */
    #edit-form-container { background: white; border-radius: 16px; border: 2px solid #e0f2f1; padding: 30px; margin-top: 25px; }
    
    /* Força o estilo dos ChoiceFields (Gênero, Etnia, etc) */
    .fieldset-body-edit select, .fieldset-body-edit input {
        display: block !important; visibility: visible !important; width: 100% !important;
        min-height: 45px !important; border: 1px solid #ddd !important; border-radius: 8px !important;
        padding: 0 15px !important; appearance: auto !important; -webkit-appearance: listbox !important;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="padding: 20px;">
    
    <a href="/admin/core/userprofile/" class="back-nav-link">
        <i class="fas fa-arrow-left mr-2"></i> VOLTAR PARA LISTAGEM
    </a>

    <div class="crm-header-card">
        <div class="row align-items-center">
            <div class="col-auto">
                {% if original.foto_rosto %}
                    <img src="{{ original.foto_rosto.url }}" style="width: 130px; height: 130px; border-radius: 50%; object-fit: cover; border: 5px solid #fcfcfc;">
                {% else %}
                    <div style="width: 130px; height: 130px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-user fa-4x text-muted"></i>
                    </div>
                {% endif %}
            </div>
            <div class="col ml-3">
                <h1 style="font-weight: 900; margin: 0; color: #1a2a3a; font-size: 2.5rem;">{{ original.nome_completo|upper }}</h1>
                <div class="mt-2">
                    <span style="background: #e0f2f1; color: #009688; padding: 5px 15px; border-radius: 20px; font-weight: 800; font-size: 0.7rem; text-transform: uppercase;">
                        {{ original.get_status_display }}
                    </span>
                    <span class="mx-3 text-muted">|</span> <small class="text-muted">ID: {{ original.uuid }}</small>
                </div>

                <div class="mt-4 d-flex flex-wrap" style="gap: 10px;">
                    <a href="{% url 'admin:userprofile_aprovar' original.pk %}" class="btn-crm" style="background: #2ecc71;">
                        <i class="fas fa-check"></i> APROVAR
                    </a>

                    <button onclick="abrirModalReprovacao('{{ original.pk }}', event)" class="btn-crm" style="background: #e74c3c;">
                        <i class="fas fa-times"></i> REPROVAR / AJUSTE
                    </button>

                    <button onclick="copiarLinkAvaliacao('{{ original.uuid }}')" class="btn-crm" style="background: #9b59b6;">
                        <i class="fas fa-star"></i> LINK AVALIAÇÃO
                    </button>

                    {% if original.whatsapp %}
                    <a href="https://wa.me/55{{ original.whatsapp|phone_digits }}" target="_blank" class="btn-crm" style="background: #25D366;">
                        <i class="fab fa-whatsapp"></i> CONVERSAR
                    </a>
                    {% endif %}

                    <div class="btn-group-custom">
                        <button class="btn-crm" style="background: #f1c40f; color: #222 !important;">
                            <i class="fas fa-key"></i> ACESSO/SENHA <i class="fas fa-chevron-down ml-1"></i>
                        </button>
                        <div class="dropdown-content">
                            <a href="{% url 'admin:userprofile_enviar_senha' original.pk %}"><i class="fas fa-envelope mr-2"></i> Enviar por E-mail</a>
                            <button onclick="copiarLinkSenha('{{ original.pk }}')"><i class="fas fa-copy mr-2"></i> Copiar Link Manual</button>
                        </div>
                    </div>

                    <div class="btn-group-custom">
                        <button class="btn-crm" style="background: #34495e;">
                            <i class="fas fa-share-alt"></i> ENVIAR CLIENTE <i class="fas fa-chevron-down ml-1"></i>
                        </button>
                        <div class="dropdown-content">
                            <button onclick="handleCopiaZap()"><i class="fab fa-whatsapp mr-2" style="color: #25D366;"></i> Gerar Texto Seletivo</button>
                            <button onclick="handleCopiaLink()"><i class="fas fa-link mr-2" style="color: #3498db;"></i> Copiar Link Seletivo</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="info-summary-grid">
        <div class="info-summary-box">
            <i class="fas fa-pencil-alt edit-pencil" onclick="toggleEditForm()"></i>
            <h4>PESSOAL</h4>
            <p><strong>Nacionalidade:</strong> {{ original.get_nacionalidade_display }}</p>
            <p><strong>Gênero:</strong> {{ original.get_genero_display }}</p>
            <p><strong>Etnia:</strong> {{ original.get_etnia_display }}</p>
            <p><strong>CPF:</strong> {{ original.cpf }}</p>
        </div>
        <div class="info-summary-box">
            <i class="fas fa-pencil-alt edit-pencil" onclick="toggleEditForm()"></i>
            <h4>FÍSICO</h4>
            <p><strong>Medidas:</strong> {{ original.altura }}m | {{ original.peso }}kg</p>
            <p><strong>Vestuário:</strong> Camiseta {{ original.get_tamanho_camiseta_display }} | Sapato {{ original.calcado }}</p>
            <p><strong>Cabelo:</strong> {{ original.get_cabelo_tipo_display }} ({{ original.get_cabelo_comprimento_display }})</p>
        </div>
        <div class="info-summary-box">
            <i class="fas fa-pencil-alt edit-pencil" onclick="toggleEditForm()"></i>
            <h4>PROFISSIONAL</h4>
            <p><strong>Inglês:</strong> {{ original.get_nivel_ingles_display }}</p>
            <p><strong>Disponibilidade:</strong> {{ original.get_disponibilidade_display }}</p>
            <p><strong>Última Atividade:</strong> {{ original.criado_em|date:"d/m/Y" }}</p>
        </div>
    </div>

    <div id="edit-form-container" style="display: none;">
        <div class="alert alert-info d-flex justify-content-between align-items-center" style="border: none; border-radius: 12px;">
            <span><i class="fas fa-edit mr-2"></i> <b>MODO DE EDIÇÃO ATIVO:</b> Altere os dados e salve para aplicar.</span>
            <button class="btn btn-sm btn-dark" onclick="toggleEditForm()">FECHAR</button>
        </div>
        
        <form {% if has_file_field %}enctype="multipart/form-data" {% endif %} action="{{ form_url }}" method="post" id="{{ opts.model_name }}_form" novalidate>
            {% csrf_token %}
            
            {% for fieldset in adminform %}
                <div style="background: #fff; border: 1px solid #eee; border-radius: 12px; margin-bottom: 25px; overflow: hidden;">
                    {% if fieldset.name %}<div style="background: #f8f9fa; padding: 12px 20px; border-bottom: 1px solid #eee;"><h2 style="font-size: 0.85rem; font-weight: 800; color: #555; margin:0;">{{ fieldset.name }}</h2></div>{% endif %}
                    <div class="fieldset-body-edit" style="padding: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                        {% for line in fieldset %}
                            {% for field in line %}
                                <div class="form-group-crm">
                                    <label style="font-weight: 800; color: #666; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 5px; display: block;">{{ field.label_tag }}</label>
                                    {% if field.is_readonly %}
                                        <div style="padding: 10px; background: #fafafa; border-radius: 8px; border: 1px solid #eee; font-weight: 600;">{{ field.contents }}</div>
                                    {% else %}
                                        {{ field.field }} {% endif %}
                                    <div class="text-danger small">{{ field.errors }}</div>
                                </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}

            <div style="text-align: right; padding: 40px 0;">
                <input type="submit" value="SALVAR PERFIL AGORA" name="_save" style="background: #009688; color: white; border: none; padding: 18px 80px; border-radius: 50px; font-weight: 900; cursor: pointer; box-shadow: 0 8px 25px rgba(0,150,136,0.3);">
            </div>
        </form>
    </div>

</div>
{% endblock %}