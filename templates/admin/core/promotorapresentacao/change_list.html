{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_list %}

{% block content %}
<div class="col-12">
    <div class="card card-primary card-outline">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-users"></i> Seleção de Apresentação
            </h3>
        </div>
        <div class="card-body">
             <p class="text-muted">
                Pesquise e selecione os promotores para gerar o link de apresentação. 
                Os promotores selecionados permanecerão na lista mesmo após nova pesquisa.
             </p>

             <!-- Search Section -->
             <div class="form-group">
                <label>Pesquisar Promotor:</label>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                    </div>
                    <input type="text" id="promoter-search" class="form-control form-control-lg" placeholder="Digite o nome, CPF ou cidade..." autocomplete="off">
                    <div class="input-group-append">
                        <button class="btn btn-primary" type="button" id="btn-open-filter">
                            <i class="fas fa-filter"></i> Filtros
                        </button>
                    </div>
                </div>
             </div>

             <!-- Filter Tags Display -->
             <div id="active-filters" class="mb-3"></div>

             <div class="row mt-4">
                 <!-- Results Column -->
                 <div class="col-md-6">
                     <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="m-0">Resultados da Busca</h5>
                        </div>
                        <div id="search-results" class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto; min-height: 100px;">
                            <p class="text-muted p-3 text-center">Comece a digitar para pesquisar...</p>
                        </div>
                     </div>
                 </div>
                 
                 <!-- Selected Column -->
                 <div class="col-md-6">
                     <div class="card border-info">
                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                            <h5 class="m-0">
                                Selecionados <span class="badge badge-light ml-2" id="selected-count" style="color: #17a2b8; font-size: 0.9rem;">0</span>
                            </h5>
                        </div>
                        
                        <div class="card-body p-0">
                            <div id="selected-list" class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto; min-height: 100px;">
                                <p class="text-muted p-3 text-center" id="empty-msg">Nenhum promotor selecionado ainda.</p>
                            </div>
                        </div>

                        <div class="card-footer">
                            <form id="action-form" method="post" action="{% url 'admin:core_promotorapresentacao_changelist' %}">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="gerar_link_apresentacao">
                                <input type="hidden" name="index" value="0">
                                <input type="hidden" name="select_across" value="0">
                                
                                <div id="hidden-inputs"></div>
                                
                                <button type="submit" class="btn btn-success btn-block" id="btn-generate" disabled>
                                    <i class="fas fa-link"></i> Gerar Link de Apresentação
                                </button>
                            </form>
                        </div>
                     </div>
                 </div>
             </div>
        </div>
    </div>
</div>


<style>
    /* Fix for nested modal backdrop issues in Jazzmin/AdminLTE */
    .modal-backdrop {
        z-index: 1040 !important;
    }
    .modal {
        z-index: 1050 !important;
    }
</style>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" role="dialog" aria-labelledby="filterModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="filterModalLabel"><i class="fas fa-filter"></i> Filtrar Promotores</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="filter-form">
          <div class="form-row">
            <div class="form-group col-md-4">
              <label>Gênero</label>
              <select class="form-control" name="genero">
                <option value="">Todos</option>
                <option value="Feminino">Feminino</option>
                <option value="Masculino">Masculino</option>
                <option value="Não-Binário">Não-Binário</option>
                <option value="Outros">Outros</option>
              </select>
            </div>
            <div class="form-group col-md-4">
              <label>Cor / Etnia</label>
              <select class="form-control" name="etnia">
                <option value="">Todas</option>
                <option value="branca">Branca</option>
                <option value="preta">Preta</option>
                <option value="parda">Parda</option>
                <option value="amarela">Amarela</option>
                <option value="indigena">Indígena</option>
              </select>
            </div>
            <div class="form-group col-md-4">
              <label>Cor dos Olhos</label>
              <select class="form-control" name="olhos">
                <option value="">Todos</option>
                <option value="castanho_escuro">Castanho Escuro</option>
                <option value="castanho_claro">Castanho Claro</option>
                <option value="azul">Azul</option>
                <option value="verde">Verde</option>
                <option value="mel">Mel</option>
                <option value="preto">Preto</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group col-md-4">
              <label>Tipo de Cabelo</label>
              <select class="form-control" name="cabelo_tipo">
                <option value="">Todos</option>
                <option value="liso">Liso</option>
                <option value="ondulado">Ondulado</option>
                <option value="cacheado">Cacheado</option>
                <option value="crespo">Crespo</option>
                <option value="black_power">Black Power</option>
                <option value="dread">Dreadlocks</option>
                <option value="trancas">Tranças</option>
              </select>
            </div>
            <div class="form-group col-md-4">
              <label>Comprimento do Cabelo</label>
              <select class="form-control" name="cabelo_comprimento">
                <option value="">Todos</option>
                <option value="curto">Curto</option>
                <option value="medio">Médio</option>
                <option value="longo">Longo</option>
                <option value="careca">Careca/Raspado</option>
              </select>
            </div>
             <div class="form-group col-md-4">
               <label>Estado (UF)</label>
               <input type="text" class="form-control" name="estado" placeholder="Ex: SP, RJ..." maxlength="2">
             </div>
          </div>

          <div class="form-row">
              <div class="form-group col-md-6">
                  <label>Cidade</label>
                  <input type="text" class="form-control" name="cidade" placeholder="Ex: São Paulo">
              </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
        <button type="button" class="btn btn-primary" id="apply-filters">Aplicar Filtros</button>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        // --- SETUP JQUERY ---
        // Using Django's namespaced jQuery or Global
        let $ = window.jQuery || window.django.jQuery;

        // FIX: Move modal to body to prevent backdrop z-index issues
        const modalEl = document.getElementById('filterModal');
        if (modalEl && document.body) {
            document.body.appendChild(modalEl);
        }
        
        // --- ELEMENTS ---
        const searchInput = document.getElementById('promoter-search');
        const resultsContainer = document.getElementById('search-results');
        const selectedContainer = document.getElementById('selected-list');
        const hiddenInputsContainer = document.getElementById('hidden-inputs');
        const selectedCountSpan = document.getElementById('selected-count');
        const btnGenerate = document.getElementById('btn-generate');
        const btnOpenFilter = document.getElementById('btn-open-filter');
        const btnApplyFilters = document.getElementById('apply-filters');
        const filterForm = document.getElementById('filter-form');
        const activeFiltersContainer = document.getElementById('active-filters');

        // State
        let selectedPromoters = new Map();

        // --- EVENT LISTENERS ---

        // Open Modal manually - Robust Check
        if(btnOpenFilter) {
            btnOpenFilter.addEventListener('click', function(e) {
                e.preventDefault();
                // Try global jQuery first (Jazzmin standard)
                if (window.jQuery && window.jQuery.fn.modal) {
                    window.jQuery('#filterModal').modal('show');
                } else if ($ && $.fn.modal) {
                    $('#filterModal').modal('show');
                } else {
                    console.error('Bootstrap Modal not loaded');
                    // Fallback: simple toggling if possible or alert
                     // Try to force display via CSS as last resort
                     document.getElementById('filterModal').classList.add('show');
                     document.getElementById('filterModal').style.display = 'block';
                     // Add close handlers manually for fallback
                     const closeBtns = document.getElementById('filterModal').querySelectorAll('[data-dismiss="modal"]');
                     closeBtns.forEach(btn => btn.onclick = () => {
                         document.getElementById('filterModal').classList.remove('show');
                         document.getElementById('filterModal').style.display = 'none';
                     });
                }
            });
        }

        // Search Input
        if(searchInput) {
            searchInput.addEventListener('input', debounce(function(e) {
                performSearch(e.target.value.trim());
            }, 500));
        }

        // Apply Filters
        if(btnApplyFilters) {
            btnApplyFilters.addEventListener('click', function() {
                 // Close modal robustly
                 if (window.jQuery && window.jQuery.fn.modal) {
                    window.jQuery('#filterModal').modal('hide');
                } else {
                     document.getElementById('filterModal').classList.remove('show');
                     document.getElementById('filterModal').style.display = 'none';
                }
                performSearch(searchInput.value.trim());
            });
        }

        // Start
        performSearch('');

        // --- FUNCTIONS ---

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function performSearch(term) {
            if(!resultsContainer) return;
            resultsContainer.innerHTML = '<div class="p-3 text-center"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>';

            const formData = new FormData(filterForm);
            const params = new URLSearchParams(formData);
            if (term) params.set('q', term);

            // Use the Django URL tag rendered in the template
            // Note: Since this is inside a template file, this renders nicely.
            const url = `{% url 'api_search_promoters' %}?${params.toString()}`;

            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Network error: ' + response.status);
                    return response.json();
                })
                .then(data => {
                    resultsContainer.innerHTML = '';
                    
                    if (!data.results || data.results.length === 0) {
                        resultsContainer.innerHTML = '<p class="text-muted p-3 text-center">Nenhum promotor encontrado.</p>';
                        return;
                    }

                    data.results.forEach(p => {
                        renderResultItem(p);
                    });
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    resultsContainer.innerHTML = `<p class="text-danger p-3 text-center">Erro ao buscar: ${error.message}</p>`;
                });
                
            updateActiveFiltersDisplay();
        }

        function renderResultItem(p) {
            const isSelected = selectedPromoters.has(String(p.id));
            
            const item = document.createElement('button');
            item.className = `list-group-item list-group-item-action d-flex align-items-center ${isSelected ? 'disabled bg-light' : ''}`;
            item.type = 'button';
            if(isSelected) item.disabled = true;

            const img = p.foto 
                ? `<img src="${p.foto}" style="width:40px; height:40px; object-fit: cover; border-radius:50%; margin-right:15px;">` 
                : `<div style="width:40px; height:40px; background:#eee; border-radius:50%; margin-right:15px; display:flex; align-items:center; justify-content:center; color:#888;"><i class="fas fa-user"></i></div>`;

            let details = [];
            if (p.cidade || p.uf) details.push(`${p.cidade || ''}/${p.uf || ''}`);
            if (p.genero) details.push(p.genero);
            if (p.altura) details.push(`${p.altura}m`);
            if (p.idade) details.push(`${p.idade} anos`);
            const detailsStr = details.join(' • ') || '-';

            item.innerHTML = `
                ${img}
                <div class="text-left">
                    <strong class="d-block text-dark">${p.text}</strong>
                    <small class="text-muted">${detailsStr}</small>
                </div>
                ${isSelected ? '<span class="ml-auto text-success"><i class="fas fa-check"></i></span>' : '<span class="ml-auto text-primary"><i class="fas fa-plus"></i></span>'}
            `;

            if (!isSelected) {
                item.onclick = () => selectPromoter(p);
            }
            resultsContainer.appendChild(item);
        }

        function selectPromoter(p) {
            selectedPromoters.set(String(p.id), p);
            renderSelected();
            performSearch(searchInput.value.trim()); 
        }

        window.removePromoter = function(id) {
            selectedPromoters.delete(String(id));
            renderSelected();
            performSearch(searchInput.value.trim());
        }

        function renderSelected() {
            selectedContainer.innerHTML = '';
            hiddenInputsContainer.innerHTML = '';
            
            let count = 0;
            
            if (selectedPromoters.size === 0) {
                selectedContainer.innerHTML = '<p class="text-muted p-3 text-center" id="empty-msg">Nenhum promotor selecionado ainda.</p>';
            }

            selectedPromoters.forEach((p, id) => {
                count++;
                
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center animate__animated animate__fadeIn';
                
                const leftDiv = document.createElement('div');
                leftDiv.className = 'd-flex align-items-center';
                
                const imgHTML = p.foto 
                    ? `<img src="${p.foto}" style="width:40px; height:40px; object-fit: cover; border-radius:50%; margin-right:15px;">`
                    : `<div style="width:40px; height:40px; background:#f4f6f9; border-radius:50%; margin-right:15px; display:flex; align-items:center; justify-content:center; color:#adb5bd;"><i class="fas fa-user"></i></div>`;
                
                leftDiv.innerHTML = `
                    ${imgHTML}
                    <div>
                        <strong>${p.text}</strong>
                    </div>
                `;
                
                item.appendChild(leftDiv);
                
                const btn = document.createElement('button');
                btn.className = 'btn btn-sm btn-outline-danger';
                btn.title = 'Remover';
                btn.innerHTML = '<i class="fas fa-trash"></i>';
                btn.onclick = () => window.removePromoter(id);
                item.appendChild(btn);
                
                selectedContainer.appendChild(item);
                
                // Input Hidden
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = '_selected_action';
                input.value = id;
                hiddenInputsContainer.appendChild(input);
            });
            
            selectedCountSpan.innerText = count;
            btnGenerate.disabled = count === 0;
        }

        function updateActiveFiltersDisplay() {
            const formData = new FormData(filterForm);
            let tags = [];
            
            formData.forEach((value, key) => {
                if(value) {
                    let label = value;
                    const selectElement = filterForm.querySelector(`select[name="${key}"]`);
                    if(selectElement) {
                        const option = Array.from(selectElement.options).find(o => o.value === value);
                        if(option) label = option.text;
                    }
                    tags.push(`
                        <span class="badge badge-info p-2 mr-2 mb-2" style="font-size: 0.9rem; font-weight: normal;">
                            ${label} 
                            <i class="fas fa-times ml-1" style="cursor:pointer;" onclick="window.clearFilter('${key}')"></i>
                        </span>
                    `);
                }
            });

            if (tags.length > 0) {
                activeFiltersContainer.innerHTML = '<small class="d-block text-muted mb-1">Filtros ativos:</small>' + tags.join('');
            } else {
                activeFiltersContainer.innerHTML = '';
            }
        }

        window.clearFilter = function(key) {
            const input = filterForm.querySelector(`[name="${key}"]`);
            if(input) {
                input.value = '';
                performSearch(searchInput.value.trim());
            }
        }
    });
</script>
{% endblock %}
