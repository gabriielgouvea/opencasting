{% extends 'base.html' %}

{% block content %}
<div style="max-width: 450px; margin: 50px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
    <h2 style="color: #009688; text-align: center;">Nova Senha</h2>
    <p style="color: #666; text-align: center; margin-bottom: 30px;">Crie uma nova senha segura para sua conta.</p>

    <form method="POST">
        {% csrf_token %}
        {% for field in form %}
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: bold; color: #444; margin-bottom: 5px;">{{ field.label }}</label>

                {% if field.field.widget.input_type == "password" %}
                    <div class="password-wrap">
                        {{ field }}
                        <button type="button" class="toggle-password" data-target="{{ field.id_for_label }}" aria-label="Mostrar senha">
                            <i class="material-icons" aria-hidden="true">visibility</i>
                        </button>
                    </div>
                {% else %}
                    {{ field }}
                {% endif %}

                {% if field.name == "new_password1" %}
                    <div class="password-rules" id="passwordRulesReset">
                        <strong>Regras de segurança da senha:</strong>
                        <ul>
                            <li data-rule="len"><i class="material-icons rule-icon">radio_button_unchecked</i> 8+ caracteres</li>
                            <li data-rule="upper"><i class="material-icons rule-icon">radio_button_unchecked</i> 1 letra maiúscula</li>
                            <li data-rule="lower"><i class="material-icons rule-icon">radio_button_unchecked</i> 1 letra minúscula</li>
                            <li data-rule="digit"><i class="material-icons rule-icon">radio_button_unchecked</i> 1 número</li>
                            <li data-rule="symbol"><i class="material-icons rule-icon">radio_button_unchecked</i> 1 símbolo (ex: ! @ #)</li>
                        </ul>
                    </div>
                {% endif %}

                {% if field.help_text %}
                    <small style="color: #888; display: block; margin-top: 3px;">{{ field.help_text }}</small>
                {% endif %}
            </div>
        {% endfor %}
        
        <button type="submit" class="btn" style="width: 100%; background: #009688; color: white; padding: 12px; border: none; border-radius: 30px; font-weight: bold; cursor: pointer; margin-top: 20px;">SALVAR NOVA SENHA</button>
    </form>
</div>

<style>
    input[type="password"], input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    .password-wrap { position: relative; }
    .password-wrap input { padding-right: 52px; }
    .toggle-password {
        position: absolute;
        top: 50%;
        right: 8px;
        transform: translateY(-50%);
        width: 38px;
        height: 38px;
        border-radius: 10px;
        border: 1px solid #e6e6e6;
        background: #fff;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #666;
    }
    .toggle-password:hover { border-color: #009688; color: #009688; }
    .password-rules {
        margin-top: 10px;
        background: #f5fcfb;
        border: 1px solid #b2dfdb;
        border-radius: 10px;
        padding: 14px;
        color: #444;
    }
    .password-rules ul { margin: 10px 0 0 0; padding-left: 0; list-style: none; }
    .password-rules li { display: flex; gap: 10px; align-items: center; margin: 6px 0; }
    .rule-icon { font-size: 18px; color: #9e9e9e; }
    .rule-ok .rule-icon { color: #2e7d32; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const passwordInput = document.getElementById('id_new_password1');
        const rulesBox = document.getElementById('passwordRulesReset');

        function getPasswordRulesState(pw) {
            const value = pw || '';
            return {
                len: value.length >= 8,
                upper: /[A-Z]/.test(value),
                lower: /[a-z]/.test(value),
                digit: /\d/.test(value),
                symbol: /[^A-Za-z0-9]/.test(value),
            };
        }

        function updateRulesUI(state) {
            if (!rulesBox) return;
            const items = rulesBox.querySelectorAll('li[data-rule]');
            items.forEach(li => {
                const rule = li.getAttribute('data-rule');
                const ok = !!state[rule];
                li.classList.toggle('rule-ok', ok);
                const icon = li.querySelector('.rule-icon');
                if (icon) icon.textContent = ok ? 'check_circle' : 'radio_button_unchecked';
            });
        }

        if (passwordInput && rulesBox) {
            updateRulesUI(getPasswordRulesState(passwordInput.value));
            passwordInput.addEventListener('input', () => updateRulesUI(getPasswordRulesState(passwordInput.value)));
        }

        document.querySelectorAll('.toggle-password').forEach(btn => {
            btn.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const input = document.getElementById(targetId);
                if (!input) return;
                const isPassword = input.type === 'password';
                input.type = isPassword ? 'text' : 'password';
                const icon = this.querySelector('i.material-icons');
                if (icon) icon.textContent = isPassword ? 'visibility_off' : 'visibility';
                this.setAttribute('aria-label', isPassword ? 'Ocultar senha' : 'Mostrar senha');
            });
        });
    });
</script>
{% endblock %}