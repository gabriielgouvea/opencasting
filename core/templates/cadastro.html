{% extends 'base.html' %}

{% block content %}

<style>
    /* --- ESTILOS DO WIZARD --- */
    .step-container { display: none; animation: fadeIn 0.4s; }
    .step-container.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Barra de Progresso */
    .progress-wrapper { margin-bottom: 30px; position: relative; padding: 0 10px; }
    .progress-track { background-color: #e0e0e0; height: 4px; width: 100%; border-radius: 2px; }
    .progress-fill { background-color: #009688; height: 100%; width: 0%; border-radius: 2px; transition: width 0.4s ease; }
    .step-dots { display: flex; justify-content: space-between; position: absolute; top: -6px; width: 100%; left: 0; }
    .dot { width: 16px; height: 16px; background: #e0e0e0; border-radius: 50%; border: 2px solid white; transition: 0.4s; }
    .dot.active { background: #009688; transform: scale(1.2); }

    /* Inputs e Bot√µes */
    .form-group { margin-bottom: 20px; text-align: left; }
    .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 0.95rem; }
    .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 1rem; box-sizing: border-box; background: #fff; }
    .form-control:focus { border-color: #009688; outline: none; box-shadow: 0 0 0 3px rgba(0,150,136,0.1); }
    .form-control.error { border-color: #e53935; box-shadow: 0 0 0 3px rgba(229, 57, 53, 0.1); }
    
    .btn { display: block; width: 100%; padding: 14px; background: var(--primary); color: white; border-radius: 25px; border: none; cursor: pointer; font-size: 1rem; font-weight: bold; margin-top: 10px; }
    .btn:hover { background-color: #00796b; }
    .btn-outline { background: transparent; border: 2px solid #ddd; color: #777; }
    .btn-outline:hover { background: #f5f5f5; }

    /* Estilo de Perguntas Extras */
    .radio-group { display: flex; gap: 10px; margin-top: 5px; }
    .radio-option { border: 1px solid #ddd; padding: 10px; border-radius: 8px; cursor: pointer; flex: 1; text-align: center; color: #555; background: #fff; transition: 0.2s; font-size: 0.9rem; }
    input[type="radio"]:checked + label { background-color: #009688; color: white; border-color: #009688; font-weight: bold; }
    input[type="radio"] { display: none; } 
    
    /* Box de Pagamento */
    .payment-warning { background: #fff8e1; border-left: 4px solid #ffc107; color: #8d6e03; padding: 15px; border-radius: 4px; font-size: 0.9rem; margin-bottom: 20px; }
    .payment-method-card { border: 2px solid #eee; padding: 15px; border-radius: 10px; text-align: center; cursor: pointer; transition: 0.2s; width: 48%; }
    .payment-method-card:hover { border-color: #009688; }
    .payment-method-card.selected { border-color: #009688; background-color: #e0f2f1; color: #00796b; font-weight: bold; }
    
    .hidden-section { display: none; margin-top: 20px; animation: fadeIn 0.3s; }

    /* Box de Upload de Foto (Estilo Clic√°vel e Moderno) */
    .photo-upload-box { 
        border: 2px dashed #ccc; 
        padding: 30px; 
        text-align: center; 
        border-radius: 12px; 
        background: #fafafa; 
        transition: 0.3s; 
        cursor: pointer !important; 
        display: block; 
        position: relative;
    }
    .photo-upload-box:hover { 
        border-color: #009688; 
        background: #e0f2f1; 
        transform: translateY(-2px);
    }
    .photo-upload-box.file-selected { 
        border-color: #2e7d32; 
        background: #e8f5e9; 
        border-style: solid; 
    }
    .photo-tips { background: #e8f5e9; padding: 15px; border-radius: 8px; font-size: 0.85rem; color: #2e7d32; margin-bottom: 20px; border-left: 4px solid #4caf50; }
</style>

<h2 style="text-align: center; color: #009688; margin-bottom: 5px;">Ficha de Cadastro</h2>
<p style="text-align: center; color: #999; font-size: 0.9rem; margin-top: 0;">Junte-se ao time em 6 passos.</p>

<div class="progress-wrapper">
    <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
    <div class="step-dots">
        <div class="dot active"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
    </div>
</div>

<form method="POST" enctype="multipart/form-data" id="wizardForm">
    {% csrf_token %}

    {% if form.errors %}
        <div style="background-color: #ffebee; color: #c62828; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ef9a9a;">
            <h3 style="margin-top: 0; font-size: 1.1rem;"><i class="material-icons" style="vertical-align: bottom;">error</i> Ops! Corrija os erros abaixo:</h3>
            <ul style="margin-bottom: 0; padding-left: 20px;">
                {% for field in form %}
                    {% for error in field.errors %}
                        <li style="margin-bottom: 5px;">
                            <strong>{{ field.label }}:</strong> {{ error }}
                        </li>
                    {% endfor %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}
    <div class="step-container active" id="step1">
        <h3 style="color: #009688;">1. Acesso</h3>
        <div class="form-group">
            <label class="form-label">Nome Completo *</label>
            {{ form.nome_completo }}
        </div>
        <div class="form-group">
            <label class="form-label">E-mail *</label>
            {{ form.email }}
        </div>
        <div class="form-group">
            <label class="form-label">Senha *</label>
            {{ form.password }}
        </div>
        <div class="form-group">
            <label class="form-label">Confirmar Senha *</label>
            {{ form.confirm_password }}
        </div>
        <button type="button" class="btn" onclick="nextStep(2)">Pr√≥ximo Passo</button>
    </div>

    <div class="step-container" id="step2">
        <h3 style="color: #009688;">2. Pessoal</h3>
        <div class="form-group">
            <label class="form-label">WhatsApp *</label>
            {{ form.whatsapp }}
        </div>
        <div class="form-group">
            <label class="form-label">Data de Nascimento *</label>
            {{ form.data_nascimento }}
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="button" class="btn btn-outline" onclick="prevStep(1)">Voltar</button>
            <button type="button" class="btn" onclick="nextStep(3)">Pr√≥ximo Passo</button>
        </div>
    </div>

    <div class="step-container" id="step3">
        <h3 style="color: #009688;">3. Endere√ßo</h3>
        <div class="form-group">
            <label class="form-label">CEP *</label>
            {{ form.cep }}
            <small style="color: #009688; display: none;" id="cep-loading">Buscando endere√ßo...</small>
        </div>
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
            <div class="form-group"><label class="form-label">Endere√ßo *</label>{{ form.endereco }}</div>
            <div class="form-group"><label class="form-label">N√∫mero *</label>{{ form.numero }}</div>
        </div>
        <div class="form-group"><label class="form-label">Bairro *</label>{{ form.bairro }}</div>
        <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 10px;">
            <div class="form-group"><label class="form-label">Cidade *</label>{{ form.cidade }}</div>
            <div class="form-group"><label class="form-label">UF *</label>{{ form.estado }}</div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="button" class="btn btn-outline" onclick="prevStep(2)">Voltar</button>
            <button type="button" class="btn" onclick="nextStep(4)">Pr√≥ximo Passo</button>
        </div>
    </div>

    <div class="step-container" id="step4">
        <h3 style="color: #009688;">4. Perfil</h3>
        <div class="form-group"><label class="form-label">Altura *</label>{{ form.altura }}</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group"><label class="form-label">Manequim *</label>{{ form.manequim }}</div>
            <div class="form-group"><label class="form-label">Cal√ßado *</label>{{ form.calcado }}</div>
        </div>
        
        {% if perguntas_extras %}
            <hr style="border: 0; border-top: 1px solid #eee; margin: 25px 0;">
            {% for pergunta in perguntas_extras %}
                <div class="form-group">
                    <label class="form-label">{{ pergunta.texto }}</label>
                    {% if pergunta.tipo == 'sim_nao' %}
                        <div class="radio-group">
                            <input type="radio" id="p{{pergunta.id}}_sim" name="pergunta_{{pergunta.id}}" value="Sim">
                            <label class="radio-option" for="p{{pergunta.id}}_sim">Sim</label>
                            
                            <input type="radio" id="p{{pergunta.id}}_nao" name="pergunta_{{pergunta.id}}" value="N√£o">
                            <label class="radio-option" for="p{{pergunta.id}}_nao">N√£o</label>
                        </div>
                    {% else %}
                        <input type="text" name="pergunta_{{pergunta.id}}" class="form-control" placeholder="Sua resposta...">
                    {% endif %}
                </div>
            {% endfor %}
        {% endif %}

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="button" class="btn btn-outline" onclick="prevStep(3)">Voltar</button>
            <button type="button" class="btn" onclick="nextStep(5)">Pr√≥ximo Passo</button>
        </div>
    </div>

    <div class="step-container" id="step5">
        <h3 style="color: #009688;">5. Dados Banc√°rios</h3>
        
        <div class="payment-warning">
            <i class="material-icons" style="vertical-align: bottom; font-size: 18px;">warning</i>
            Pagamento somente em conta do titular (mesmo CPF).
        </div>

        <div class="form-group">
            <label class="form-label">Seu CPF (Obrigat√≥rio) *</label>
            {{ form.cpf }}
        </div>

        <label class="form-label" style="margin-top: 20px;">Selecione a Forma de Recebimento *</label>
        <input type="hidden" id="payment_method_selected" required>

        <div style="display: flex; gap: 10px; justify-content: space-between;">
            <div class="payment-method-card" onclick="selectPayment('pix')" id="card-pix">
                <i class="material-icons">qr_code</i><br>PIX
            </div>
            <div class="payment-method-card" onclick="selectPayment('bank')" id="card-bank">
                <i class="material-icons">account_balance</i><br>Transfer√™ncia
            </div>
        </div>

        <div id="fields-pix" class="hidden-section">
            <div class="form-group">
                <label class="form-label">Tipo de Chave *</label>
                {{ form.tipo_chave_pix }}
            </div>
            <div class="form-group">
                <label class="form-label">Chave PIX *</label>
                {{ form.chave_pix }}
            </div>
        </div>

        <div id="fields-bank" class="hidden-section">
            <div class="form-group"><label class="form-label">Banco *</label>{{ form.banco }}</div>
            <div class="form-group"><label class="form-label">Tipo de Conta *</label>{{ form.tipo_conta }}</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="form-group"><label class="form-label">Ag√™ncia *</label>{{ form.agencia }}</div>
                <div class="form-group"><label class="form-label">Conta *</label>{{ form.conta }}</div>
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 30px;">
            <button type="button" class="btn btn-outline" onclick="prevStep(4)">Voltar</button>
            <button type="button" class="btn" onclick="nextStep(6)">Pr√≥ximo Passo</button>
        </div>
    </div>

    <div class="step-container" id="step6">
        <h3 style="color: #009688;">6. Suas Fotos</h3>
        
        <div class="photo-tips">
            <strong>üì∏ Dicas para aprova√ß√£o r√°pida:</strong>
            <ul style="margin: 5px 0 0 20px; padding: 0;">
                <li>Envie fotos recentes e com boa ilumina√ß√£o.</li>
                <li>Evite √≥culos escuros, bon√©s ou fotos em grupo.</li>
            </ul>
        </div>

        <div style="display: grid; gap: 20px; margin-top: 20px;">
            
            <div class="photo-upload-box" id="box-rosto" onclick="triggerUpload('input_foto_rosto')">
                <i class="material-icons" style="font-size: 40px; color: #009688;">face</i>
                <div style="font-weight: bold; margin-top: 10px; color: #555;">Toque para enviar Foto de Rosto</div>
                <div style="font-size: 0.8rem; color: #999;" id="text-rosto">(Nenhum arquivo selecionado)</div>
                <div style="height: 0; overflow: hidden; opacity: 0;">{{ form.foto_rosto }}</div>
            </div>

            <div class="photo-upload-box" id="box-corpo" onclick="triggerUpload('input_foto_corpo')">
                <i class="material-icons" style="font-size: 40px; color: #009688;">accessibility_new</i>
                <div style="font-weight: bold; margin-top: 10px; color: #555;">Toque para enviar Foto de Corpo</div>
                <div style="font-size: 0.8rem; color: #999;" id="text-corpo">(Nenhum arquivo selecionado)</div>
                <div style="height: 0; overflow: hidden; opacity: 0;">{{ form.foto_corpo }}</div>
            </div>

        </div>

        <div style="display: flex; gap: 10px; margin-top: 30px;">
            <button type="button" class="btn btn-outline" onclick="prevStep(5)">Voltar</button>
            <button type="submit" class="btn" style="background-color: #4CAF50; color: white;">FINALIZAR CADASTRO ‚ú®</button>
        </div>
    </div>

</form>

<script>
    // --- 1. FUN√á√ÉO FOR√áAR UPLOAD ---
    function triggerUpload(fieldId) {
        const fileInput = document.getElementById(fieldId);
        if (fileInput) {
            fileInput.click();
        } else {
            console.error("Campo de arquivo n√£o encontrado: " + fieldId);
        }
    }

    // --- 2. CONFIGURA√á√ÉO DEFENSIVA ---
    document.addEventListener("DOMContentLoaded", function() {
        
        // Monitora o campo de Rosto
        const rostoInput = document.getElementById('input_foto_rosto'); // Aten√ß√£o ao ID
        if (rostoInput) {
            rostoInput.addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    const text = document.getElementById('text-rosto');
                    const box = document.getElementById('box-rosto');
                    if(text) {
                        text.innerText = "Arquivo: " + this.files[0].name;
                        text.style.color = "#2e7d32";
                        text.style.fontWeight = "bold";
                    }
                    if(box) box.classList.add('file-selected');
                }
            });
        }

        // Monitora o campo de Corpo
        const corpoInput = document.getElementById('input_foto_corpo'); // Aten√ß√£o ao ID
        if (corpoInput) {
            corpoInput.addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    const text = document.getElementById('text-corpo');
                    const box = document.getElementById('box-corpo');
                    if(text) {
                        text.innerText = "Arquivo: " + this.files[0].name;
                        text.style.color = "#2e7d32";
                        text.style.fontWeight = "bold";
                    }
                    if(box) box.classList.add('file-selected');
                }
            });
        }

        // --- AUTOMA√á√ÉO CPF -> PIX ---
        const tipoPixSelect = document.getElementById('id_tipo_chave_pix');
        // O campo CPF √© gerado com id_cpf pelo Django
        const cpfInput = document.getElementById('id_cpf');
        const chavePixInput = document.getElementById('id_chave_pix');

        if (tipoPixSelect && cpfInput && chavePixInput) {
            tipoPixSelect.addEventListener('change', function() {
                if (this.value === 'cpf') {
                    chavePixInput.value = cpfInput.value;
                } else if (this.value === '') {
                    chavePixInput.value = '';
                }
            });
        }

        // Garante 'required' nos campos fixos ao carregar
        const fields = document.querySelectorAll('.form-control');
        fields.forEach(f => {
            const name = f.name;
            const opcionais = ['tipo_chave_pix', 'chave_pix', 'banco', 'agencia', 'conta', 'tipo_conta', 'foto_rosto', 'foto_corpo'];
            if (!f.closest('.hidden-section') && !opcionais.includes(name)) {
                f.setAttribute('required', 'true');
            }
        });
    });

    // --- 3. L√ìGICA DE PAGAMENTO ---
    function selectPayment(type) {
        document.getElementById('card-pix').classList.remove('selected');
        document.getElementById('card-bank').classList.remove('selected');
        document.getElementById('fields-pix').style.display = 'none';
        document.getElementById('fields-bank').style.display = 'none';
        
        const hiddenInput = document.getElementById('payment_method_selected');
        if(hiddenInput) hiddenInput.value = type;

        setRequired('fields-pix', false);
        setRequired('fields-bank', false);

        if (type === 'pix') {
            document.getElementById('card-pix').classList.add('selected');
            document.getElementById('fields-pix').style.display = 'block';
            setRequired('fields-pix', true);
        } else {
            document.getElementById('card-bank').classList.add('selected');
            document.getElementById('fields-bank').style.display = 'block';
            setRequired('fields-bank', true);
        }
    }

    function setRequired(containerId, isRequired) {
        const container = document.getElementById(containerId);
        if (!container) return;
        const inputs = container.querySelectorAll('input, select');
        inputs.forEach(input => {
            if (isRequired) input.setAttribute('required', 'true');
            else input.removeAttribute('required');
        });
    }

    // --- 4. NAVEGA√á√ÉO E VALIDA√á√ÉO ---
    let currentStep = 1;
    const totalSteps = 6;

    window.nextStep = function(targetStep) {
        const currentDiv = document.getElementById('step' + currentStep);
        let valid = true;
        
        const inputs = currentDiv.querySelectorAll('input[required], select[required]');
        
        inputs.forEach(input => {
            if (!input.checkValidity()) {
                valid = false;
                input.classList.add('error');
                input.reportValidity();
            } else {
                input.classList.remove('error');
            }
        });

        if (currentStep === 5 && valid) {
            const payMethod = document.getElementById('payment_method_selected');
            if (payMethod && !payMethod.value) {
                alert("Por favor, selecione PIX ou Transfer√™ncia.");
                valid = false;
            }
        }

        if (!valid) return;

        document.getElementById('step' + currentStep).classList.remove('active');
        currentStep = targetStep;
        document.getElementById('step' + currentStep).classList.add('active');
        updateProgress();
        window.scrollTo(0, 0);
    }

    window.prevStep = function(step) {
        document.getElementById('step' + currentStep).classList.remove('active');
        currentStep = step;
        document.getElementById('step' + currentStep).classList.add('active');
        updateProgress();
    }

    function updateProgress() {
        const percent = ((currentStep - 1) / (totalSteps - 1)) * 100;
        const bar = document.getElementById('progressFill');
        if(bar) bar.style.width = percent + '%';
        
        document.querySelectorAll('.dot').forEach((dot, index) => {
            if (index < currentStep) dot.classList.add('active');
            else dot.classList.remove('active');
        });
    }

    // --- 5. M√ÅSCARAS ---
    const applyMask = (selector, formatFunc) => {
        const el = document.querySelector(selector);
        if(el) el.addEventListener('input', e => { e.target.value = formatFunc(e.target.value.replace(/\D/g, '')); });
    };

    applyMask('.cpf-mask', v => {
        if (v.length > 3) v = v.substring(0, 3) + '.' + v.substring(3);
        if (v.length > 7) v = v.substring(0, 7) + '.' + v.substring(7);
        if (v.length > 11) v = v.substring(0, 11) + '-' + v.substring(11, 13);
        return v;
    });

    applyMask('.cep-mask', v => {
        if (v.length > 5) v = v.substring(0, 5) + '-' + v.substring(5, 8);
        return v;
    });

    applyMask('.phone-mask', v => {
        if (v.length > 0) v = '(' + v;
        if (v.length > 3) v = v.substring(0, 3) + ') ' + v.substring(3);
        if (v.length > 10) v = v.substring(0, 10) + '-' + v.substring(10, 14);
        return v;
    });

    applyMask('.date-mask', v => {
        if (v.length > 2) v = v.substring(0, 2) + '/' + v.substring(2);
        if (v.length > 5) v = v.substring(0, 5) + '/' + v.substring(5, 9);
        return v;
    });

    applyMask('.height-mask', v => {
        if (v.length > 2) v = v.substring(0, 1) + '.' + v.substring(1, 3);
        return v;
    });

    // --- 6. VIA CEP ---
    const cepField = document.querySelector('.cep-mask');
    if(cepField) {
        cepField.addEventListener('blur', function(e) {
            let cep = e.target.value.replace(/\D/g, '');
            if (cep.length === 8) {
                const loading = document.getElementById('cep-loading');
                if(loading) loading.style.display = 'block';
                
                fetch(`https://viacep.com.br/ws/${cep}/json/`)
                    .then(r => r.json())
                    .then(d => {
                        if (!d.erro) {
                            if(document.getElementById('id_endereco')) document.getElementById('id_endereco').value = d.logradouro;
                            if(document.getElementById('id_bairro')) document.getElementById('id_bairro').value = d.bairro;
                            if(document.getElementById('id_cidade')) document.getElementById('id_cidade').value = d.localidade;
                            if(document.getElementById('id_estado')) document.getElementById('id_estado').value = d.uf;
                        }
                        if(loading) loading.style.display = 'none';
                    })
                    .catch(() => { if(loading) loading.style.display = 'none'; });
            }
        });
    }
</script>

{% endblock %}