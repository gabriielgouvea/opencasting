{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
    /* ==========================================================================
       ESTILOS PERSONALIZADOS DO WIZARD DE CADASTRO
       ========================================================================== */
    
    /* Container das etapas com anima√ß√£o */
    .step-container { 
        display: none; 
        animation: fadeIn 0.4s ease-in-out; 
    }
    .step-container.active { 
        display: block; 
    }
    @keyframes fadeIn { 
        from { opacity: 0; transform: translateY(10px); } 
        to { opacity: 1; transform: translateY(0); } 
    }

    /* Barra de Progresso Superior */
    .progress-wrapper { 
        margin-bottom: 40px; 
        position: relative; 
        padding: 0 15px; 
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }
    .progress-track { 
        background-color: #e0e0e0; 
        height: 6px; 
        width: 100%; 
        border-radius: 3px; 
        position: relative;
        top: 5px;
        z-index: 1;
    }
    .progress-fill { 
        background-color: #009688; 
        height: 100%; 
        width: 0%; 
        border-radius: 3px; 
        transition: width 0.4s ease; 
    }
    .step-dots { 
        display: flex; 
        justify-content: space-between; 
        position: absolute; 
        top: -2px; 
        width: 100%; 
        left: 0; 
        z-index: 2;
        padding: 0 15px; /* Alinha com o wrapper */
        box-sizing: border-box;
    }
    .dot { 
        width: 20px; 
        height: 20px; 
        background: #e0e0e0; 
        border-radius: 50%; 
        border: 3px solid #fff; 
        transition: 0.4s; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .dot.active { 
        background: #009688; 
        transform: scale(1.3); 
        box-shadow: 0 0 0 4px rgba(0, 150, 136, 0.2);
    }

    /* Formul√°rios e Inputs */
    .form-group { 
        margin-bottom: 25px; 
        text-align: left; 
    }
    .form-label { 
        display: block; 
        margin-bottom: 8px; 
        font-weight: 600; 
        color: #333; 
        font-size: 0.95rem; 
    }
    .form-control { 
        width: 100%; 
        padding: 12px 15px; 
        border: 1px solid #ddd; 
        border-radius: 8px; 
        font-size: 1rem; 
        box-sizing: border-box; 
        background: #fff; 
        transition: border-color 0.3s, box-shadow 0.3s;
    }
    .form-control:focus { 
        border-color: #009688; 
        outline: none; 
        box-shadow: 0 0 0 4px rgba(0,150,136,0.1); 
    }
    .form-control.error { 
        border-color: #e53935; 
        box-shadow: 0 0 0 4px rgba(229, 57, 53, 0.1); 
    }

    /* Senha: olhinho + checklist */
    .password-wrap { position: relative; }
    .password-wrap .form-control { padding-right: 52px; }
    .toggle-password {
        position: absolute;
        top: 50%;
        right: 10px;
        transform: translateY(-50%);
        width: 38px;
        height: 38px;
        border-radius: 10px;
        border: 1px solid #e6e6e6;
        background: #fff;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #666;
    }
    .toggle-password:hover { border-color: #009688; color: #009688; }
    .password-rules {
        margin-top: 12px;
        background: #f5fcfb;
        border: 1px solid #b2dfdb;
        border-radius: 10px;
        padding: 14px;
        color: #444;
    }
    .password-rules ul { margin: 10px 0 0 0; padding-left: 0; list-style: none; }
    .password-rules li { display: flex; gap: 10px; align-items: center; margin: 6px 0; }
    .rule-icon { font-size: 18px; color: #9e9e9e; }
    .rule-ok .rule-icon { color: #2e7d32; }
    
    /* Bot√µes de Navega√ß√£o */
    .btn { 
        display: block; 
        width: 100%; 
        padding: 15px; 
        background: var(--primary, #009688); 
        color: white; 
        border-radius: 30px; 
        border: none; 
        cursor: pointer; 
        font-size: 1.1rem; 
        font-weight: bold; 
        margin-top: 15px; 
        transition: transform 0.2s, background-color 0.2s;
    }
    .btn:hover { 
        background-color: #00796b; 
        transform: translateY(-2px);
    }
    .btn-outline { 
        background: transparent; 
        border: 2px solid #ddd; 
        color: #777; 
    }
    .btn-outline:hover { 
        background: #f5f5f5; 
        border-color: #bbb;
        transform: none;
    }

    /* Checkbox Grid (√Åreas de Atua√ß√£o) */
    .checkbox-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
        gap: 12px; 
        margin-top: 15px; 
    }
    .form-check-input-custom { 
        list-style: none; 
        padding: 0; 
        margin: 0; 
    }
    .form-check-input-custom li { 
        margin-bottom: 8px; 
        display: flex; 
        align-items: center; 
        background: #fff;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #eee;
    }
    .form-check-input-custom input { 
        margin-right: 10px; 
        transform: scale(1.3); 
        accent-color: #009688; 
        cursor: pointer;
    }
    .form-check-input-custom label { 
        color: #555; 
        cursor: pointer; 
        font-size: 0.95rem; 
        display: inline-block; 
        width: 100%;
    }

    /* Box de Upload de Foto */
    .photo-upload-box { 
        border: 2px dashed #ccc; 
        padding: 40px 20px; 
        text-align: center; 
        border-radius: 15px; 
        background: #fafafa; 
        transition: 0.3s; 
        cursor: pointer !important; 
        display: block; 
        position: relative;
    }
    .photo-upload-box:hover { 
        border-color: #009688; 
        background: #e0f2f1; 
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    .photo-upload-box.file-selected { 
        border-color: #2e7d32; 
        background: #e8f5e9; 
        border-style: solid; 
        border-width: 2px;
    }
    .photo-tips { 
        background: #e8f5e9; 
        padding: 20px; 
        border-radius: 10px; 
        font-size: 0.9rem; 
        color: #2e7d32; 
        margin-bottom: 25px; 
        border-left: 5px solid #4caf50; 
    }

    /* Box de Pagamento */
    .payment-warning { 
        background: #fff8e1; 
        border-left: 5px solid #ffc107; 
        color: #8d6e03; 
        padding: 15px; 
        border-radius: 6px; 
        font-size: 0.95rem; 
        margin-bottom: 25px; 
    }
    .payment-method-card { 
        border: 2px solid #eee; 
        padding: 20px; 
        border-radius: 12px; 
        text-align: center; 
        cursor: pointer; 
        transition: 0.2s; 
        width: 48%; 
        background: #fff;
    }
    .payment-method-card:hover { 
        border-color: #009688; 
        background: #f0fdfc;
    }
    .payment-method-card.selected { 
        border-color: #009688; 
        background-color: #e0f2f1; 
        color: #00796b; 
        font-weight: bold; 
        box-shadow: 0 4px 10px rgba(0,150,136,0.15);
    }
    .hidden-section { 
        display: none; 
        margin-top: 25px; 
        animation: fadeIn 0.3s; 
    }

    /* Spinner de Carregamento */
    .spinner-border { 
        vertical-align: text-bottom; 
        margin-right: 8px; 
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spinner-border .75s linear infinite;
    }
    @keyframes spinner-border { 
        to { transform: rotate(360deg); } 
    }
</style>

<div style="max-width: 800px; margin: 40px auto; padding: 20px;">
    <h2 style="text-align: center; color: #009688; margin-bottom: 10px; font-weight: 800;">Ficha de Cadastro</h2>
    <p style="text-align: center; color: #777; font-size: 1rem; margin-top: 0; margin-bottom: 30px;">
        Complete seu perfil para ter acesso √†s vagas.
    </p>

    <div class="progress-wrapper">
        <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
        <div class="step-dots">
            <div class="dot active"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>
    </div>

    <form method="POST" enctype="multipart/form-data" id="wizardForm" style="background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05);">
        {% csrf_token %}

        {% if form.errors %}
            <div style="background-color: #ffebee; color: #c62828; padding: 15px; border-radius: 8px; margin-bottom: 25px; border: 1px solid #ef9a9a;">
                <h4 style="margin: 0 0 10px 0;"><i class="material-icons" style="vertical-align: bottom;">error</i> Aten√ß√£o:</h4>
                <ul style="margin: 0; padding-left: 20px;">
                    {% for field in form %}
                        {% for error in field.errors %}
                            <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        <div class="step-container active" id="step1">
            <h3 style="color: #009688; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 25px;">1. Dados de Acesso</h3>
            
            <div class="form-group">
                <label class="form-label">Nome Completo *</label>
                {{ form.nome_completo }}
            </div>
            
            <div class="form-group">
                <label class="form-label">E-mail *</label>
                {{ form.email }}
            </div>
            
            <div class="form-group">
                <label class="form-label">Senha *</label>
                <div class="password-wrap">
                    {{ form.password }}
                    <button type="button" class="toggle-password" data-target="id_password" aria-label="Mostrar senha">
                        <i class="material-icons" aria-hidden="true">visibility</i>
                    </button>
                </div>
                <div class="password-rules" id="passwordRulesCadastro">
                    <strong>Regras de seguran√ßa da senha:</strong>
                    <ul>
                        <li data-rule="len"><i class="material-icons rule-icon">radio_button_unchecked</i> 8+ caracteres</li>
                        <li data-rule="upper"><i class="material-icons rule-icon">radio_button_unchecked</i> 1 letra mai√∫scula</li>
                        <li data-rule="lower"><i class="material-icons rule-icon">radio_button_unchecked</i> 1 letra min√∫scula</li>
                        <li data-rule="digit"><i class="material-icons rule-icon">radio_button_unchecked</i> 1 n√∫mero</li>
                        <li data-rule="symbol"><i class="material-icons rule-icon">radio_button_unchecked</i> 1 s√≠mbolo (ex: ! @ #)</li>
                    </ul>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Confirmar Senha *</label>
                <div class="password-wrap">
                    {{ form.confirm_password }}
                    <button type="button" class="toggle-password" data-target="id_confirm_password" aria-label="Mostrar senha">
                        <i class="material-icons" aria-hidden="true">visibility</i>
                    </button>
                </div>
            </div>
            
            <button type="button" class="btn" onclick="nextStep(2)">Pr√≥ximo Passo</button>
        </div>

        <div class="step-container" id="step2">
            <h3 style="color: #009688; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 25px;">2. Pessoal & Documentos</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group"><label class="form-label">CPF *</label>{{ form.cpf }}</div>
                <div class="form-group"><label class="form-label">RG / RNE</label>{{ form.rg }}</div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group"><label class="form-label">WhatsApp *</label>{{ form.whatsapp }}</div>
                <div class="form-group"><label class="form-label">Data de Nascimento *</label>{{ form.data_nascimento }}</div>
            </div>

            <div class="form-group">
                <label class="form-label">Instagram (Opcional)</label>
                {{ form.instagram }}
            </div>

            <div class="form-group">
                <label class="form-label">Nacionalidade</label>
                {{ form.nacionalidade }}
            </div>

            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; border: 1px solid #eee; margin-top: 15px;">
                <div class="form-group" style="margin-bottom: 5px;">
                    <label style="cursor: pointer; display: flex; align-items: center; font-weight: 600; color: #555;">
                        {{ form.is_pcd }} 
                        <span style="margin-left: 10px;">Sou PCD (Pessoa com Defici√™ncia)</span>
                    </label>
                </div>
                <div id="pcd-desc-container" style="display: none; margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ddd;">
                    <label class="form-label">Qual a defici√™ncia?</label>
                    {{ form.descricao_pcd }}
                </div>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button type="button" class="btn btn-outline" onclick="prevStep(1)">Voltar</button>
                <button type="button" class="btn" onclick="nextStep(3)">Pr√≥ximo Passo</button>
            </div>
        </div>

        <div class="step-container" id="step3">
            <h3 style="color: #009688; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 25px;">3. Endere√ßo</h3>
            
            <div class="form-group">
                <label class="form-label">CEP *</label>
                {{ form.cep }}
                <small style="color: #009688; display: none; margin-top: 5px;" id="cep-loading">
                    <span class="spinner-border spinner-border-sm"></span> Buscando endere√ßo...
                </small>
            </div>
            
            <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 15px;">
                <div class="form-group"><label class="form-label">Endere√ßo *</label>{{ form.endereco }}</div>
                <div class="form-group"><label class="form-label">N√∫mero *</label>{{ form.numero }}</div>
            </div>
            
            <div class="form-group"><label class="form-label">Bairro *</label>{{ form.bairro }}</div>
            
            <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 15px;">
                <div class="form-group"><label class="form-label">Cidade *</label>{{ form.cidade }}</div>
                <div class="form-group"><label class="form-label">UF *</label>{{ form.estado }}</div>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button type="button" class="btn btn-outline" onclick="prevStep(2)">Voltar</button>
                <button type="button" class="btn" onclick="nextStep(4)">Pr√≥ximo Passo</button>
            </div>
        </div>

        <div class="step-container" id="step4">
            <h3 style="color: #009688; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 25px;">4. Perfil F√≠sico</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group"><label class="form-label">G√™nero</label>{{ form.genero }}</div>
                <div class="form-group"><label class="form-label">Cor / Etnia</label>{{ form.etnia }}</div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group"><label class="form-label">Altura (m) *</label>{{ form.altura }}</div>
                <div class="form-group"><label class="form-label">Peso (kg)</label>{{ form.peso }}</div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div class="form-group"><label class="form-label">Manequim</label>{{ form.manequim }}</div>
                <div class="form-group"><label class="form-label">Cal√ßado</label>{{ form.calcado }}</div>
                <div class="form-group"><label class="form-label">Camiseta</label>{{ form.tamanho_camiseta }}</div>
            </div>

            <h4 style="margin: 25px 0 15px 0; color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px;">Rosto & Cabelo</h4>

            <div class="form-group"><label class="form-label">Cor dos Olhos</label>{{ form.olhos }}</div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group"><label class="form-label">Tipo de Cabelo</label>{{ form.cabelo_tipo }}</div>
                <div class="form-group"><label class="form-label">Comprimento</label>{{ form.cabelo_comprimento }}</div>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button type="button" class="btn btn-outline" onclick="prevStep(3)">Voltar</button>
                <button type="button" class="btn" onclick="nextStep(5)">Pr√≥ximo Passo</button>
            </div>
        </div>

        <div class="step-container" id="step5">
            <h3 style="color: #009688; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 25px;">5. Profissional</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group"><label class="form-label">Experi√™ncia</label>{{ form.experiencia }}</div>
                <div class="form-group"><label class="form-label">Disponibilidade</label>{{ form.disponibilidade }}</div>
            </div>

            <div class="form-group" style="background: #f5fcfb; padding: 20px; border-radius: 10px; border: 1px solid #b2dfdb;">
                <label class="form-label" style="color: #00796b; font-size: 1.1rem; margin-bottom: 15px;">Quais fun√ß√µes voc√™ realiza? (Marque v√°rias)</label>
                
                <div class="checkbox-grid">
                    {{ form.areas_interesse }}
                </div>
                
                <div id="div-outros-areas" style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed #b2dfdb; display:none;">
                    <label class="form-label">Qual outra fun√ß√£o?</label>
                    {{ form.areas_outros_texto }}
                </div>
            </div>

            <h4 style="margin: 25px 0 15px 0; color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px;">Idiomas</h4>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                <div class="form-group"><label class="form-label">Ingl√™s</label>{{ form.nivel_ingles }}</div>
                <div class="form-group"><label class="form-label">Espanhol</label>{{ form.nivel_espanhol }}</div>
                <div class="form-group"><label class="form-label">Franc√™s</label>{{ form.nivel_frances }}</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Outros Idiomas? (Descreva)</label>
                {{ form.outros_idiomas }}
            </div>

            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button type="button" class="btn btn-outline" onclick="prevStep(4)">Voltar</button>
                <button type="button" class="btn" onclick="nextStep(6)">Pr√≥ximo Passo</button>
            </div>
        </div>

        <div class="step-container" id="step6">
            <h3 style="color: #009688; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 25px;">6. Dados Banc√°rios</h3>
            
            <div class="payment-warning">
                <i class="material-icons" style="vertical-align: bottom;">warning</i>
                <strong>Importante:</strong> Pagamento realizado somente em conta do titular (mesmo CPF).
            </div>

            <div class="form-group">
                <label class="form-label">Seu CPF (Obrigat√≥rio) *</label>
                {{ form.cpf }}
            </div>

            <label class="form-label" style="margin-top: 25px;">Forma de Recebimento *</label>
            <input type="hidden" id="payment_method_selected" required>

            <div style="display: flex; gap: 15px; justify-content: space-between;">
                <div class="payment-method-card" onclick="selectPayment('pix')" id="card-pix">
                    <i class="material-icons" style="font-size: 30px;">qr_code</i><br>
                    <span style="font-weight: 500;">PIX</span>
                </div>
                <div class="payment-method-card" onclick="selectPayment('bank')" id="card-bank">
                    <i class="material-icons" style="font-size: 30px;">account_balance</i><br>
                    <span style="font-weight: 500;">Transfer√™ncia</span>
                </div>
            </div>

            <div id="fields-pix" class="hidden-section">
                <div class="form-group"><label class="form-label">Tipo de Chave *</label>{{ form.tipo_chave_pix }}</div>
                <div class="form-group"><label class="form-label">Chave PIX *</label>{{ form.chave_pix }}</div>
            </div>

            <div id="fields-bank" class="hidden-section">
                <div class="form-group"><label class="form-label">Banco *</label>{{ form.banco }}</div>
                <div class="form-group"><label class="form-label">Tipo de Conta *</label>{{ form.tipo_conta }}</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group"><label class="form-label">Ag√™ncia *</label>{{ form.agencia }}</div>
                    <div class="form-group"><label class="form-label">Conta *</label>{{ form.conta }}</div>
                </div>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button type="button" class="btn btn-outline" onclick="prevStep(5)">Voltar</button>
                <button type="button" class="btn" onclick="nextStep(7)">Pr√≥ximo Passo</button>
            </div>
        </div>

        <div class="step-container" id="step7">
            <h3 style="color: #009688; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 25px;">7. Fotos e Finaliza√ß√£o</h3>
            
            <div class="photo-tips">
                <strong>üì∏ Dicas para aprova√ß√£o r√°pida:</strong>
                <ul style="margin: 10px 0 0 20px; padding: 0;">
                    <li>Envie fotos recentes e com boa ilumina√ß√£o.</li>
                    <li>Evite √≥culos escuros, bon√©s ou fotos em grupo.</li>
                    <li>Fundo neutro √© sempre melhor.</li>
                    <li>Proibido foto no espelho (selfie no espelho reprova).</li>
                    <li>Evite filtros pesados e fotos muito editadas.</li>
                    <li>Fotos borradas/escurecidas ou com ‚Äúprint de tela‚Äù n√£o s√£o aceitas.</li>
                    <li>Mostre bem o rosto e o corpo (sem cortes).</li>
                </ul>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 25px;">
                
                <div class="photo-upload-box" id="box-rosto" onclick="triggerUpload('input_foto_rosto')">
                    <i class="material-icons" style="font-size: 40px; color: #009688;">face</i>
                    <div style="font-weight: bold; margin-top: 10px; color: #555;">Foto de Rosto (Close)</div>
                    <div style="font-size: 0.8rem; color: #999; margin-top: 5px;" id="text-rosto">(Nenhum arquivo selecionado)</div>
                    <div style="height: 0; overflow: hidden; opacity: 0;">{{ form.foto_rosto }}</div>
                </div>

                <div class="photo-upload-box" id="box-corpo" onclick="triggerUpload('input_foto_corpo')">
                    <i class="material-icons" style="font-size: 40px; color: #009688;">accessibility_new</i>
                    <div style="font-weight: bold; margin-top: 10px; color: #555;">Foto de Corpo Inteiro</div>
                    <div style="font-size: 0.8rem; color: #999; margin-top: 5px;" id="text-corpo">(Nenhum arquivo selecionado)</div>
                    <div style="height: 0; overflow: hidden; opacity: 0;">{{ form.foto_corpo }}</div>
                </div>

            </div>

            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-top: 30px; border: 1px solid #eee;">
                <h4 style="color: #009688; margin-top:0; font-size: 1rem; margin-bottom: 15px;">üìù Termos e Autoriza√ß√µes</h4>
                
                <div class="form-group" style="margin-bottom: 15px;">
                    <div style="display:flex; gap:12px; align-items:flex-start;">
                        {{ form.termo_uso_imagem }}
                        <label for="{{ form.termo_uso_imagem.id_for_label }}" style="font-size:0.9rem; color:#555; cursor:pointer; line-height: 1.4;">
                            {{ form.termo_uso_imagem.label }}
                        </label>
                    </div>
                    <div style="color:red; font-size:0.85rem; margin-left: 30px;">{{ form.termo_uso_imagem.errors }}</div>
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                    <div style="display:flex; gap:12px; align-items:flex-start;">
                        {{ form.termo_comunicacao }}
                        <label for="{{ form.termo_comunicacao.id_for_label }}" style="font-size:0.9rem; color:#555; cursor:pointer; line-height: 1.4;">
                            {{ form.termo_comunicacao.label }}
                        </label>
                    </div>
                    <div style="color:red; font-size:0.85rem; margin-left: 30px;">{{ form.termo_comunicacao.errors }}</div>
                </div>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 35px;">
                <button type="button" class="btn btn-outline" onclick="prevStep(6)">Voltar</button>
                
                <button type="submit" class="btn" style="background-color: #4CAF50; color: white;" id="btnEnviar">FINALIZAR CADASTRO ‚ú®</button>
                
                <button type="button" class="btn" style="background-color: #9E9E9E; color: white; display:none; cursor: not-allowed;" id="btnLoading" disabled>
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    Enviando fotos, aguarde...
                </button>
            </div>
        </div>

    </form>
</div>

<script>
    // --- 1. FUN√á√ÉO FOR√áAR UPLOAD AO CLICAR NA CAIXA ---
    function triggerUpload(fieldId) {
        const fileInput = document.getElementById(fieldId);
        if (fileInput) {
            fileInput.click();
        } else {
            console.error("Campo de arquivo n√£o encontrado: " + fieldId);
        }
    }

    // --- 2. CONFIGURA√á√ïES AO CARREGAR A P√ÅGINA ---
    document.addEventListener("DOMContentLoaded", function() {
        
        // Listener PCD (Mostra/Esconde campo de descri√ß√£o)
        const pcdCheck = document.querySelector('input[name="is_pcd"]');
        const pcdDiv = document.getElementById('pcd-desc-container');
        if(pcdCheck) {
            pcdCheck.addEventListener('change', function() {
                pcdDiv.style.display = this.checked ? 'block' : 'none';
            });
        }

        // Listener √Åreas (Se marcar "Outros", abre caixa de texto)
        const checkboxes = document.querySelectorAll('input[name="areas_interesse"]');
        const outrosDiv = document.getElementById('div-outros-areas');
        
        checkboxes.forEach(cb => {
            cb.addEventListener('change', function() {
                // Se o checkbox "outros" for alterado, mostramos a div
                if(this.value === 'outros') {
                    outrosDiv.style.display = this.checked ? 'block' : 'none';
                }
            });
        });

        // Configura√ß√µes de uploads (Muda texto e cor ao selecionar arquivo)
        setupFileUpload('input_foto_rosto', 'text-rosto', 'box-rosto');
        setupFileUpload('input_foto_corpo', 'text-corpo', 'box-corpo');

        // Autopreenchimento PIX se for CPF
        const tipoPixSelect = document.getElementById('id_tipo_chave_pix');
        const cpfInput = document.getElementById('id_cpf');
        const chavePixInput = document.getElementById('id_chave_pix');

        if (tipoPixSelect && cpfInput && chavePixInput) {
            tipoPixSelect.addEventListener('change', function() {
                if (this.value === 'cpf') {
                    chavePixInput.value = cpfInput.value;
                } else if (this.value === '') {
                    chavePixInput.value = '';
                }
            });
        }

        // Estado de Carregamento no Submit
        const form = document.getElementById('wizardForm');
        if(form) {
            form.addEventListener('submit', function() {
                document.getElementById('btnEnviar').style.display = 'none';
                document.getElementById('btnLoading').style.display = 'block';
            });
        }

        // Senha: checklist + olhinho
        const passwordInput = document.getElementById('id_password');
        const rulesBox = document.getElementById('passwordRulesCadastro');

        function getPasswordRulesState(pw) {
            const value = pw || '';
            return {
                len: value.length >= 8,
                upper: /[A-Z]/.test(value),
                lower: /[a-z]/.test(value),
                digit: /\d/.test(value),
                symbol: /[^A-Za-z0-9]/.test(value),
            };
        }

        function updateRulesUI(state) {
            if (!rulesBox) return;
            const items = rulesBox.querySelectorAll('li[data-rule]');
            items.forEach(li => {
                const rule = li.getAttribute('data-rule');
                const ok = !!state[rule];
                li.classList.toggle('rule-ok', ok);
                const icon = li.querySelector('.rule-icon');
                if (icon) icon.textContent = ok ? 'check_circle' : 'radio_button_unchecked';
            });
        }

        if (passwordInput && rulesBox) {
            updateRulesUI(getPasswordRulesState(passwordInput.value));
            passwordInput.addEventListener('input', () => updateRulesUI(getPasswordRulesState(passwordInput.value)));
        }

        document.querySelectorAll('.toggle-password').forEach(btn => {
            btn.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const input = document.getElementById(targetId);
                if (!input) return;
                const isPassword = input.type === 'password';
                input.type = isPassword ? 'text' : 'password';
                const icon = this.querySelector('i.material-icons');
                if (icon) icon.textContent = isPassword ? 'visibility_off' : 'visibility';
                this.setAttribute('aria-label', isPassword ? 'Ocultar senha' : 'Mostrar senha');
            });
        });
    });

    // Fun√ß√£o auxiliar para os uploads
    function setupFileUpload(inputId, textId, boxId) {
        const input = document.getElementById(inputId);
        if(!input) return;
        input.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const txt = document.getElementById(textId);
                const box = document.getElementById(boxId);
                if(txt) {
                    txt.innerText = "Arquivo: " + this.files[0].name;
                    txt.style.color = "#2e7d32";
                    txt.style.fontWeight = "bold";
                }
                if(box) box.classList.add('file-selected');
            }
        });
    }

    // --- 3. L√ìGICA DE PAGAMENTO (PIX vs TRANSFER√äNCIA) ---
    function selectPayment(type) {
        // Reseta visual
        document.getElementById('card-pix').classList.remove('selected');
        document.getElementById('card-bank').classList.remove('selected');
        document.getElementById('fields-pix').style.display = 'none';
        document.getElementById('fields-bank').style.display = 'none';
        
        // Define o valor no input hidden
        const hiddenInput = document.getElementById('payment_method_selected');
        if(hiddenInput) hiddenInput.value = type;

        // Limpa obrigatoriedade de todos
        setRequired('fields-pix', false);
        setRequired('fields-bank', false);

        // Ativa o selecionado
        if (type === 'pix') {
            document.getElementById('card-pix').classList.add('selected');
            document.getElementById('fields-pix').style.display = 'block';
            setRequired('fields-pix', true);
        } else {
            document.getElementById('card-bank').classList.add('selected');
            document.getElementById('fields-bank').style.display = 'block';
            setRequired('fields-bank', true);
        }
    }

    function setRequired(containerId, isRequired) {
        const c = document.getElementById(containerId);
        if(!c) return;
        c.querySelectorAll('input, select').forEach(i => {
            if(isRequired) i.setAttribute('required', 'true');
            else i.removeAttribute('required');
        });
    }

    // --- 4. NAVEGA√á√ÉO WIZARD & VALIDA√á√ÉO ---
    let currentStep = 1;
    const totalSteps = 7;

    window.nextStep = function(targetStep) {
        const currentDiv = document.getElementById('step' + currentStep);
        let valid = true;

        // Valida√ß√£o de campos vis√≠veis e obrigat√≥rios
        const inputs = currentDiv.querySelectorAll('input, select');
        
        inputs.forEach(input => {
            // Verifica apenas se o campo est√° vis√≠vel, possui required e n√£o est√° vazio
            // (input.offsetParent !== null checa se o elemento est√° vis√≠vel na tela)
            if (input.offsetParent !== null && input.hasAttribute('required')) {
                // Valida√ß√£o especial para Checkbox (Termos)
                if (input.type === 'checkbox') {
                     if (!input.checked) {
                         valid = false;
                         input.parentNode.style.color = 'red'; // Feedback visual r√°pido
                     } else {
                         input.parentNode.style.color = '';
                     }
                } else {
                    // Valida√ß√£o de inputs normais (Texto, Select)
                    if (!input.value || input.value.trim() === "") {
                         valid = false;
                         input.classList.add('error');
                    } else {
                        input.classList.remove('error');
                    }
                }
            }
        });

        // Valida√ß√£o espec√≠fica do passo 6 (Pagamento)
        if (currentStep === 6 && valid) {
            const payMethod = document.getElementById('payment_method_selected');
            if (payMethod && !payMethod.value) {
                alert("Por favor, selecione PIX ou Transfer√™ncia.");
                valid = false;
            }
        }

        if (!valid) {
            // Foca no primeiro erro encontrado
            const erro = currentDiv.querySelector('.error');
            if(erro) erro.focus();
            else if(currentStep !== 7) alert("Preencha todos os campos obrigat√≥rios.");
            return;
        }

        // Troca de passo
        document.getElementById('step' + currentStep).classList.remove('active');
        currentStep = targetStep;
        document.getElementById('step' + currentStep).classList.add('active');
        updateProgress();
        window.scrollTo(0, 0);
    }

    window.prevStep = function(step) {
        document.getElementById('step' + currentStep).classList.remove('active');
        currentStep = step;
        document.getElementById('step' + currentStep).classList.add('active');
        updateProgress();
    }

    function updateProgress() {
        const percent = ((currentStep - 1) / (totalSteps - 1)) * 100;
        document.getElementById('progressFill').style.width = percent + '%';
        
        document.querySelectorAll('.dot').forEach((dot, index) => {
            if (index < currentStep) dot.classList.add('active');
            else dot.classList.remove('active');
        });
    }

    // --- 5. M√ÅSCARAS DE ENTRADA ---
    const applyMask = (selector, formatFunc) => {
        const el = document.querySelector(selector);
        if(el) el.addEventListener('input', e => { e.target.value = formatFunc(e.target.value.replace(/\D/g, '')); });
    };

    applyMask('.cpf-mask', v => {
        if (v.length > 3) v = v.substring(0, 3) + '.' + v.substring(3);
        if (v.length > 7) v = v.substring(0, 7) + '.' + v.substring(7);
        if (v.length > 11) v = v.substring(0, 11) + '-' + v.substring(11, 13);
        return v;
    });

    applyMask('.phone-mask', v => {
        if (v.length > 0) v = '(' + v;
        if (v.length > 3) v = v.substring(0, 3) + ') ' + v.substring(3);
        if (v.length > 10) v = v.substring(0, 10) + '-' + v.substring(10, 14);
        return v;
    });

    applyMask('.cep-mask', v => {
        if (v.length > 5) v = v.substring(0, 5) + '-' + v.substring(5, 8);
        return v;
    });

    applyMask('.date-mask', v => {
        if (v.length > 2) v = v.substring(0, 2) + '/' + v.substring(2);
        if (v.length > 5) v = v.substring(0, 5) + '/' + v.substring(5, 9);
        return v;
    });

    // M√°scara Inteligente de Altura (170 -> 1.70)
    applyMask('.height-mask', v => {
        if(v.length > 2) return v.substring(0,1) + '.' + v.substring(1,3);
        return v;
    });

    // M√°scara Inteligente de Peso (Calculadora: 65 -> 0.65 -> 65.00)
    const pesoInput = document.querySelector('.weight-mask');
    if(pesoInput) {
        pesoInput.addEventListener('input', function(e) {
            let v = e.target.value.replace(/\D/g, ''); // Apenas n√∫meros
            if (v === '') { e.target.value = ''; return; }
            // Divide por 100 para criar o decimal (ex: 6500 -> 65.00)
            v = (parseInt(v) / 100).toFixed(2); 
            e.target.value = v;
        });
    }

    // --- 6. BUSCA DE CEP AUTOM√ÅTICA ---
    const cepField = document.querySelector('.cep-mask');
    if(cepField) {
        cepField.addEventListener('blur', function(e) {
            let cep = e.target.value.replace(/\D/g, '');
            if (cep.length === 8) {
                const loading = document.getElementById('cep-loading');
                if(loading) loading.style.display = 'block';
                
                fetch(`https://viacep.com.br/ws/${cep}/json/`)
                    .then(r => r.json())
                    .then(d => {
                        if (!d.erro) {
                            if(document.getElementById('id_endereco')) document.getElementById('id_endereco').value = d.logradouro;
                            if(document.getElementById('id_bairro')) document.getElementById('id_bairro').value = d.bairro;
                            if(document.getElementById('id_cidade')) document.getElementById('id_cidade').value = d.localidade;
                            if(document.getElementById('id_estado')) document.getElementById('id_estado').value = d.uf;
                        }
                        if(loading) loading.style.display = 'none';
                    })
                    .catch(() => { if(loading) loading.style.display = 'none'; });
            }
        });
    }
</script>

{% endblock %}